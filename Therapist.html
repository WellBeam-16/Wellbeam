<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WellBeam - Patient Monitoring Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #4285f4;
        --primary-dark: #3367d6;
        --secondary: #34a853;
        --danger: #ea4335;
        --warning: #fbbc05;
        --light: #f8f9fa;
        --dark: #202124;
        --gray: #dadce0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f0f2f5;
        color: var(--dark);
      }

      .container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 15px;
      }

      header {
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
      }

      .logo i {
        color: var(--primary);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .user-info .doctor-name {
        font-weight: 500;
      }

      .login-section,
      .dashboard {
        margin-top: 80px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .login-section {
        max-width: 500px;
        margin: 100px auto;
        text-align: center;
      }

      .login-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 30px auto;
        transition: background-color 0.3s;
      }

      .login-btn:hover {
        background-color: var(--primary-dark);
      }

      .dashboard {
        display: none;
        margin-top: 100px;
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .search-bar {
        flex: 1;
        max-width: 300px;
        position: relative;
      }

      .search-bar input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid var(--gray);
        border-radius: 5px;
        font-size: 1rem;
      }

      .search-bar i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }

      .filter-options {
        display: flex;
        gap: 15px;
      }

      .filter-btn {
        background-color: white;
        border: 1px solid var(--gray);
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
      }

      .filter-btn:hover,
      .filter-btn.active {
        background-color: var(--light);
        border-color: var(--primary);
        color: var(--primary);
      }

      .patients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .patient-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
        position: relative;
      }

      .patient-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .patient-header {
        padding: 15px;
        background-color: var(--light);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .patient-name {
        font-weight: bold;
        font-size: 1.2rem;
      }

      .patient-id {
        color: #666;
        font-size: 0.9rem;
      }

      .criticality {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        color: white;
      }

      .criticality.high {
        background-color: var(--danger);
      }

      .criticality.medium {
        background-color: var(--warning);
      }

      .criticality.low {
        background-color: var(--secondary);
      }

      .patient-body {
        padding: 15px;
      }

      .patient-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
      }

      .info-label {
        font-size: 0.8rem;
        color: #666;
      }

      .info-value {
        font-weight: 500;
      }

      .patient-metrics {
        margin-top: 15px;
      }

      .metric {
        margin-bottom: 10px;
      }

      .metric-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }

      .metric-label {
        font-size: 0.9rem;
        font-weight: 500;
      }

      .metric-value {
        font-size: 0.9rem;
        font-weight: bold;
      }

      .progress-bar {
        height: 8px;
        background-color: var(--gray);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
      }

      .progress.green {
        background-color: var(--secondary);
      }

      .progress.blue {
        background-color: var(--primary);
      }

      .progress.yellow {
        background-color: var(--warning);
      }

      .progress.red {
        background-color: var(--danger);
      }

      .patient-footer {
        padding: 15px;
        border-top: 1px solid var(--gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .timestamp {
        font-size: 0.8rem;
        color: #666;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
        transition: color 0.3s;
      }

      .action-btn:hover {
        color: var(--primary);
      }

      .select-patient {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 24px;
        height: 24px;
        border: 2px solid var(--gray);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
      }

      .select-patient.selected {
        background-color: var(--secondary);
        border-color: var(--secondary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .patient-details-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        width: 90%;
        max-width: 900px;
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        animation: slideIn 0.3s forwards;
      }

      @keyframes slideIn {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 20px;
        background-color: var(--primary);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: bold;
      }

      .close-modal {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .modal-body {
        padding: 20px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .patient-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .details-section {
        background-color: var(--light);
        border-radius: 10px;
        padding: 20px;
      }

      .section-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: var(--primary);
      }

      .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .chart-container {
        height: 300px;
        margin-top: 20px;
      }

      .logout-btn {
        background-color: transparent;
        border: 1px solid var(--gray);
        color: #666;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background-color: #f1f3f4;
        color: var(--danger);
        border-color: var(--danger);
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        color: var(--danger);
        text-align: center;
        margin: 20px 0;
      }

      .selected-patients-bar {
        background-color: rgba(52, 168, 83, 0.1);
        border-top: 1px solid var(--secondary);
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        transform: translateY(100%);
        transition: transform 0.3s;
        z-index: 99;
      }

      .selected-patients-bar.active {
        transform: translateY(0);
      }

      .selected-count {
        font-weight: 500;
        color: var(--secondary);
      }

      .action-group {
        display: flex;
        gap: 10px;
      }

      .action-group button {
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        border: none;
        transition: all 0.3s;
      }

      .select-all-btn {
        background-color: var(--light);
        color: var(--dark);
        border: 1px solid var(--gray);
      }

      .select-all-btn:hover {
        background-color: var(--gray);
      }

      .clear-selection-btn {
        background-color: transparent;
        color: #666;
        border: 1px solid var(--gray);
      }

      .clear-selection-btn:hover {
        background-color: #f1f3f4;
      }

      .take-action-btn {
        background-color: var(--secondary);
        color: white;
      }

      .take-action-btn:hover {
        background-color: #2e9748;
      }

      @media (max-width: 768px) {
        .patients-grid {
          grid-template-columns: 1fr;
        }

        .patient-details {
          grid-template-columns: 1fr;
        }

        .dashboard-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .search-bar {
          max-width: 100%;
          width: 100%;
        }

        .filter-options {
          width: 100%;
          overflow-x: auto;
          padding-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <i class="fas fa-heartbeat"></i>
            <span>WellBeam</span>
          </div>
          <div class="user-info">
            <span class="doctor-name" id="doctorName">Doctor Name</span>
            <img
              id="doctorPhoto"
              src="/api/placeholder/40/40"
              alt="Doctor Photo"
            />
            <button id="logoutBtn" class="logout-btn">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <div id="loginSection" class="login-section">
        <h2>Welcome to WellBeam</h2>
        <p>Patient Monitoring Dashboard</p>
        <button id="loginBtn" class="login-btn">
          <i class="fab fa-google"></i>
          Sign in with Google
        </button>
      </div>

      <div id="dashboard" class="dashboard">
        <div class="dashboard-header">
          <h2>Patient Dashboard</h2>
          <div class="search-bar">
            <input
              type="text"
              id="searchInput"
              placeholder="Search patients..."
            />
            <i class="fas fa-search"></i>
          </div>
          <div class="filter-options">
            <button class="filter-btn active" data-filter="all">
              <i class="fas fa-users"></i>
              All Patients
            </button>
            <button class="filter-btn" data-filter="critical">
              <i class="fas fa-exclamation-triangle"></i>
              Critical
            </button>
            <button class="filter-btn" data-filter="suicidal">
              <i class="fas fa-heartbeat"></i>
              Suicidal Thoughts
            </button>
            <button class="filter-btn" data-filter="social">
              <i class="fas fa-user-friends"></i>
              Low Social
            </button>
          </div>
        </div>

        <div id="loadingIndicator" class="loading">
          <div class="spinner"></div>
        </div>

        <div
          id="errorMessage"
          class="error-message"
          style="display: none"
        ></div>

        <div id="patientsGrid" class="patients-grid"></div>
      </div>
    </div>

    <div id="patientDetailsModal" class="patient-details-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalPatientName">Patient Details</h3>
          <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="modalContent">
          <div class="patient-details">
            <div class="details-section">
              <h4 class="section-title">Personal Information</h4>
              <div class="details-grid" id="personalInfo">
                <!-- Personal info will be populated here -->
              </div>
            </div>
            <div class="details-section">
              <h4 class="section-title">Mental Health Status</h4>
              <div class="details-grid" id="mentalHealthInfo">
                <!-- Mental health info will be populated here -->
              </div>
            </div>
          </div>
          <div class="details-section">
            <h4 class="section-title">Health Metrics</h4>
            <div class="chart-container">
              <canvas id="healthMetricsChart"></canvas>
            </div>
          </div>
          <div class="details-section">
            <h4 class="section-title">Critical Indicators</h4>
            <div class="chart-container">
              <canvas id="criticalityChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="selected-patients-bar" id="selectedPatientsBar">
      <div class="selected-count" id="selectedCount">0 patients selected</div>
      <div class="action-group">
        <button class="select-all-btn" id="selectAllBtn">Select All</button>
        <button class="clear-selection-btn" id="clearSelectionBtn">
          Clear Selection
        </button>
        <button class="take-action-btn" id="takeActionBtn">Take Action</button>
      </div>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDKkJc0SbCronxQP6KZcCLJLzGSF-qFXDs",
        authDomain: "wellbeam-35e71.firebaseapp.com",
        projectId: "wellbeam-35e71",
        storageBucket: "wellbeam-35e71.firebasestorage.app",
        messagingSenderId: "789976919078",
        appId: "1:789976919078:web:21a48c02c0f234cc05cae7",
        measurementId: "G-0QMP2392MZ",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // DOM Elements
      const loginSection = document.getElementById("loginSection");
      const dashboard = document.getElementById("dashboard");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const doctorName = document.getElementById("doctorName");
      const doctorPhoto = document.getElementById("doctorPhoto");
      const patientsGrid = document.getElementById("patientsGrid");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const errorMessage = document.getElementById("errorMessage");
      const searchInput = document.getElementById("searchInput");
      const filterButtons = document.querySelectorAll(".filter-btn");
      const patientDetailsModal = document.getElementById(
        "patientDetailsModal"
      );
      const closeModal = document.getElementById("closeModal");
      const modalPatientName = document.getElementById("modalPatientName");
      const personalInfo = document.getElementById("personalInfo");
      const mentalHealthInfo = document.getElementById("mentalHealthInfo");
      const selectedPatientsBar = document.getElementById(
        "selectedPatientsBar"
      );
      const selectedCount = document.getElementById("selectedCount");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const clearSelectionBtn = document.getElementById("clearSelectionBtn");
      const takeActionBtn = document.getElementById("takeActionBtn");

      // State variables
      let patientsData = [];
      let filteredPatients = [];
      let selectedPatients = new Set();
      let currentFilter = "all";
      let searchQuery = "";
      let healthMetricsChart = null;
      let criticalityChart = null;

      // Helper functions to calculate criticality scores
      function calculateCriticality(patient) {
        let score = 0;

        // Check for suicidal thoughts
        if (patient.suicidal_thoughts === "Yes") {
          score += 50;
        }

        // Check stress levels
        if (patient.stress === "Yes") {
          score += 30;
        }

        // Check mood
        if (
          patient.mood === "Sad" ||
          patient.mood === "Depressed" ||
          patient.mood === "Anxious"
        ) {
          score += 25;
        } else if (patient.mood !== "Happy") {
          score += 15;
        }

        // Check sleep
        if (patient.sleep === "Poor" || patient.sleep === "Very poor") {
          score += 20;
        } else if (patient.sleep !== "Very well") {
          score += 10;
        }

        // Check social score
        if (patient.social === "0" || patient.social === "Less than 2") {
          score += 25;
        } else if (patient.social === "2-5") {
          score += 10;
        }

        // Return criticality level based on score
        if (score >= 50) {
          return { level: "high", score };
        } else if (score >= 25) {
          return { level: "medium", score };
        } else {
          return { level: "low", score };
        }
      }

      // Convert survey values to numeric values for visualization
 // Convert survey values to numeric values for visualization
function getMetricValue(metric, value) {
  switch (metric) {
      case 'mood':
          const moodMap = { "Happy": 100, "Neutral": 70, "Sad": 40, "Depressed": 20, "Anxious": 30 };
          return moodMap[value] || 50;
      case 'sleep':
          const sleepMap = { "Very well": 100, "Well": 80, "Average": 60, "Poor": 30, "Very poor": 10 };
          return sleepMap[value] || 50;
      case 'stress':
          // Reversed - "No" is good (100), "Yes" is bad (20)
          return value === "No" ? 100 : 20;
      case 'suicidal_thoughts':
          // Reversed - "No" is good (100), "Yes" is very bad (10)
          return value === "No" ? 100 : 10;
      case 'social':
          const socialMap = { "More than 5": 100, "2-5": 70, "Less than 2": 40, "0": 10 };
          return socialMap[value] || 50;
      case 'selfcare':
          return value === "Yes" ? 100 : 40;
      case 'appetite':
          const appetiteMap = { "High": 80, "Normal": 100, "Low": 40, "Very low": 20 };
          return appetiteMap[value] || 60;
      case 'energy':
          const energyMap = { "High": 100, "Normal": 80, "Low": 40, "Very low": 20 };
          return energyMap[value] || 60;
      default:
          return 50;
  }
}
      // Get color based on value
      function getColorForValue(value) {
        if (value >= 80) return "green";
        if (value >= 60) return "blue";
        if (value >= 40) return "yellow";
        return "red";
      }

      // Authentication with Google
      loginBtn.addEventListener("click", () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => {
          console.error("Error during authentication:", error);
          showError("Authentication failed. Please try again.");
        });
      });

      // Logout
      logoutBtn.addEventListener("click", () => {
        auth.signOut();
      });

      // Auth state change listener
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed in
          doctorName.textContent = user.displayName || "Doctor";
          if (user.photoURL) {
            doctorPhoto.src = user.photoURL;
          }

          loginSection.style.display = "none";
          dashboard.style.display = "block";

          // Load patient data
          loadPatientData();
        } else {
          // User is signed out
          loginSection.style.display = "block";
          dashboard.style.display = "none";
          selectedPatientsBar.classList.remove("active");
        }
      });

      // Load patient data from Firestore
      function loadPatientData() {
        loadingIndicator.style.display = "flex";
        patientsGrid.innerHTML = "";
        errorMessage.style.display = "none";

        db.collection("survey_responses")
          .get()
          .then((querySnapshot) => {
            patientsData = [];
            querySnapshot.forEach((doc) => {
              const patientData = doc.data();
              patientData.id = doc.id;
              patientData.criticality = calculateCriticality(patientData);
              patientsData.push(patientData);
            });

            // Sort by criticality (high to low)
            patientsData.sort(
              (a, b) => b.criticality.score - a.criticality.score
            );

            // Apply current filter and search
            applyFiltersAndSearch();

            loadingIndicator.style.display = "none";
          })
          .catch((error) => {
            console.error("Error loading patient data:", error);
            loadingIndicator.style.display = "none";
            showError("Error loading patient data. Please try again later.");
          });
      }

      // Show error message
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      // Apply filters and search
      function applyFiltersAndSearch() {
        // Apply search filter
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          filteredPatients = patientsData.filter(
            (patient) =>
              (patient.patientName &&
                patient.patientName.toLowerCase().includes(query)) ||
              (patient.patientId &&
                patient.patientId.toLowerCase().includes(query))
          );
        } else {
          filteredPatients = [...patientsData];
        }

        // Apply category filter
        if (currentFilter === "critical") {
          filteredPatients = filteredPatients.filter(
            (patient) => patient.criticality.level === "high"
          );
        } else if (currentFilter === "suicidal") {
          filteredPatients = filteredPatients.filter(
            (patient) => patient.suicidal_thoughts === "Yes"
          );
        } else if (currentFilter === "social") {
          filteredPatients = filteredPatients.filter(
            (patient) =>
              patient.social === "0" || patient.social === "Less than 2"
          );
        }

        // Render patients
        renderPatients();

        // Update selected patients bar
        updateSelectedPatientsBar();
      }

      // Render patients grid
      function renderPatients() {
        patientsGrid.innerHTML = "";

        if (filteredPatients.length === 0) {
          patientsGrid.innerHTML =
            '<div class="error-message">No patients match your criteria.</div>';
          return;
        }

        filteredPatients.forEach((patient) => {
          const card = createPatientCard(patient);
          patientsGrid.appendChild(card);
        });
      }

      // Create patient card
      // Create patient card
      function createPatientCard(patient) {
        const card = document.createElement("div");
        card.className = "patient-card";
        card.dataset.patientId = patient.id;

        // Check if this patient is selected
        if (selectedPatients.has(patient.id)) {
          card.classList.add("selected");
        }

        // Create select checkbox
        const selectCheckbox = document.createElement("div");
        selectCheckbox.className = selectedPatients.has(patient.id)
          ? "select-patient selected"
          : "select-patient";
        if (selectedPatients.has(patient.id)) {
          selectCheckbox.innerHTML = '<i class="fas fa-check"></i>';
        }
        selectCheckbox.addEventListener("click", (e) => {
          e.stopPropagation();
          togglePatientSelection(patient.id);
        });

        // Create patient header
        const header = document.createElement("div");
        header.className = "patient-header";

        const nameInfo = document.createElement("div");
        nameInfo.innerHTML = `
      <div class="patient-name">${patient.patientName || "Unknown"}</div>
      <div class="patient-id">${patient.patientId || "No ID"}</div>
  `;

        const criticality = document.createElement("div");
        criticality.className = `criticality ${patient.criticality.level}`;
        criticality.textContent =
          patient.criticality.level.charAt(0).toUpperCase() +
          patient.criticality.level.slice(1);

        header.appendChild(nameInfo);
        header.appendChild(criticality);

        // Create patient body
        const body = document.createElement("div");
        body.className = "patient-body";

        // Basic info
        const info = document.createElement("div");
        info.className = "patient-info";

        // Add contact info
        info.innerHTML = `
      <div class="info-item">
          <span class="info-label">Phone</span>
          <span class="info-value">${patient.patientPhoneNumber || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Email</span>
          <span class="info-value">${patient.patientEmail || "N/A"}</span>
      </div>
  `;

        body.appendChild(info);

        // Add metrics
        const metrics = document.createElement("div");
        metrics.className = "patient-metrics";

        // Critical metrics first
        const criticalMetrics = [
          "mood",
          "suicidal_thoughts",
          "stress",
          "sleep",
          "social",
        ];

        criticalMetrics.forEach((metric) => {
          if (patient[metric]) {
            const metricValue = getMetricValue(metric, patient[metric]);
            const metricColor = getColorForValue(metricValue);

            const metricDiv = document.createElement("div");
            metricDiv.className = "metric";

            const metricHeader = document.createElement("div");
            metricHeader.className = "metric-header";

            const metricLabel = document.createElement("div");
            metricLabel.className = "metric-label";
            metricLabel.textContent =
              metric.charAt(0).toUpperCase() +
              metric.slice(1).replace("_", " ");

            const metricValueEl = document.createElement("div");
            metricValueEl.className = "metric-value";
            metricValueEl.textContent = patient[metric];

            metricHeader.appendChild(metricLabel);
            metricHeader.appendChild(metricValueEl);

            const progressBar = document.createElement("div");
            progressBar.className = "progress-bar";

            const progress = document.createElement("div");
            progress.className = `progress ${metricColor}`;
            progress.style.width = `${metricValue}%`;

            progressBar.appendChild(progress);

            metricDiv.appendChild(metricHeader);
            metricDiv.appendChild(progressBar);

            metrics.appendChild(metricDiv);
          }
        });

        body.appendChild(metrics);

        // Create patient footer
        const footer = document.createElement("div");
        footer.className = "patient-footer";

        const timestamp = document.createElement("div");
        timestamp.className = "timestamp";
        timestamp.textContent = patient.timestamp || "No timestamp";

        const actionButtons = document.createElement("div");
        actionButtons.className = "action-buttons";

        const viewButton = document.createElement("button");
        viewButton.className = "action-btn view-details";
        viewButton.innerHTML = '<i class="fas fa-eye"></i>';
        viewButton.addEventListener("click", (e) => {
          e.stopPropagation();
          openPatientDetails(patient);
        });

        actionButtons.appendChild(viewButton);

        footer.appendChild(timestamp);
        footer.appendChild(actionButtons);

        // Assemble card
        card.appendChild(selectCheckbox);
        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(footer);

        // Add click event to open patient details
        card.addEventListener("click", () => {
          openPatientDetails(patient);
        });

        return card;
      }

      // Toggle patient selection
      function togglePatientSelection(patientId) {
        if (selectedPatients.has(patientId)) {
          selectedPatients.delete(patientId);
        } else {
          selectedPatients.add(patientId);
        }

        // Update UI
        updateSelectedPatientsBar();
        renderPatients();
      }

      // Update selected patients bar
      function updateSelectedPatientsBar() {
        if (selectedPatients.size > 0) {
          selectedCount.textContent = `${selectedPatients.size} patient${
            selectedPatients.size > 1 ? "s" : ""
          } selected`;
          selectedPatientsBar.classList.add("active");
        } else {
          selectedPatientsBar.classList.remove("active");
        }
      }

      // Select all patients
      selectAllBtn.addEventListener("click", () => {
        filteredPatients.forEach((patient) => {
          selectedPatients.add(patient.id);
        });
        updateSelectedPatientsBar();
        renderPatients();
      });

      // Clear selection
      clearSelectionBtn.addEventListener("click", () => {
        selectedPatients.clear();
        updateSelectedPatientsBar();
        renderPatients();
      });

      // Take action button
      takeActionBtn.addEventListener("click", () => {
        alert(`Taking action on ${selectedPatients.size} selected patients`);
        // Implement action functionality here
      });

      // Open patient details modal
      function openPatientDetails(patient) {
        modalPatientName.textContent = patient.patientName || "Unknown Patient";

        // Populate personal info
        personalInfo.innerHTML = `
      <div class="info-item">
          <span class="info-label">Patient ID</span>
          <span class="info-value">${patient.patientId || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Phone</span>
          <span class="info-value">${patient.patientPhoneNumber || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Email</span>
          <span class="info-value">${patient.patientEmail || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Guardian Phone</span>
          <span class="info-value">${
            patient.patientGuardianPhoneNumber || "N/A"
          }</span>
      </div>
  `;

        // Populate mental health info
        mentalHealthInfo.innerHTML = `
      <div class="info-item">
          <span class="info-label">Mood</span>
          <span class="info-value">${patient.mood || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Sleep</span>
          <span class="info-value">${patient.sleep || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Stress</span>
          <span class="info-value">${patient.stress || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Suicidal Thoughts</span>
          <span class="info-value">${patient.suicidal_thoughts || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Social Interactions</span>
          <span class="info-value">${patient.social || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Self-care</span>
          <span class="info-value">${patient.selfcare || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Appetite</span>
          <span class="info-value">${patient.appetite || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Energy</span>
          <span class="info-value">${patient.energy || "N/A"}</span>
      </div>
      <div class="info-item">
          <span class="info-label">Thoughts</span>
          <span class="info-value">${patient.thoughts || "N/A"}</span>
      </div>
  `;

        // Create health metrics chart
        createHealthMetricsChart(patient);

        // Create criticality chart
        createCriticalityChart(patient);

        // Show modal
        patientDetailsModal.style.display = "flex";
      }

      // Create health metrics chart
      function createHealthMetricsChart(patient) {
        const ctx = document
          .getElementById("healthMetricsChart")
          .getContext("2d");

        // Destroy previous chart if exists
        if (healthMetricsChart) {
          healthMetricsChart.destroy();
        }

        // Get metrics for chart
        const metrics = [
          "mood",
          "sleep",
          "stress",
          "suicidal_thoughts",
          "social",
          "selfcare",
          "appetite",
          "energy",
        ];
        const labels = metrics.map(
          (metric) =>
            metric.charAt(0).toUpperCase() + metric.slice(1).replace("_", " ")
        );
        const values = metrics.map((metric) =>
          getMetricValue(metric, patient[metric] || "")
        );
        const backgroundColors = values.map((value) => {
          const color = getColorForValue(value);
          switch (color) {
            case "green":
              return "rgba(52, 168, 83, 0.7)";
            case "blue":
              return "rgba(66, 133, 244, 0.7)";
            case "yellow":
              return "rgba(251, 188, 5, 0.7)";
            case "red":
              return "rgba(234, 67, 53, 0.7)";
            default:
              return "rgba(66, 133, 244, 0.7)";
          }
        });

        // Create chart
        healthMetricsChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Health Metrics",
                data: values,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map((color) =>
                  color.replace("0.7", "1")
                ),
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const metric = metrics[context.dataIndex];
                    const value = patient[metric] || "N/A";
                    return `${value} (${context.formattedValue}%)`;
                  },
                },
              },
            },
          },
        });
      }

      // Create criticality chart
      function createCriticalityChart(patient) {
        const ctx = document
          .getElementById("criticalityChart")
          .getContext("2d");

        // Destroy previous chart if exists
        if (criticalityChart) {
          criticalityChart.destroy();
        }

        // Define critical metrics and their weights
        const criticalMetrics = [
          {
            name: "Suicidal Thoughts",
            weight: 50,
            value: patient.suicidal_thoughts === "Yes" ? 50 : 0,
          },
          {
            name: "Stress",
            weight: 30,
            value: patient.stress === "Yes" ? 30 : 0,
          },
          {
            name: "Mood",
            weight: 25,
            value: ["Sad", "Depressed", "Anxious"].includes(patient.mood)
              ? 25
              : patient.mood !== "Happy"
              ? 15
              : 0,
          },
          {
            name: "Sleep Quality",
            weight: 20,
            value: ["Poor", "Very poor"].includes(patient.sleep)
              ? 20
              : patient.sleep !== "Very well"
              ? 10
              : 0,
          },
          {
            name: "Social Isolation",
            weight: 25,
            value: ["0", "Less than 2"].includes(patient.social)
              ? 25
              : patient.social === "2-5"
              ? 10
              : 0,
          },
        ];

        // Sort by actual value for the chart
        criticalMetrics.sort((a, b) => b.value - a.value);

        // Create chart
        criticalityChart = new Chart(ctx, {
          type: "polarArea",
          data: {
            labels: criticalMetrics.map((m) => m.name),
            datasets: [
              {
                label: "Risk Factors",
                data: criticalMetrics.map((m) => m.value),
                backgroundColor: [
                  "rgba(234, 67, 53, 0.7)",
                  "rgba(251, 188, 5, 0.7)",
                  "rgba(66, 133, 244, 0.7)",
                  "rgba(52, 168, 83, 0.7)",
                  "rgba(121, 80, 242, 0.7)",
                ],
                borderColor: [
                  "rgba(234, 67, 53, 1)",
                  "rgba(251, 188, 5, 1)",
                  "rgba(66, 133, 244, 1)",
                  "rgba(52, 168, 83, 1)",
                  "rgba(121, 80, 242, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    const maxValue = criticalMetrics[context.dataIndex].weight;
                    return `${value}/${maxValue} (${Math.round(
                      (value / maxValue) * 100
                    )}%)`;
                  },
                },
              },
            },
            scales: {
              r: {
                max: 50,
              },
            },
          },
        });
      }

      // Close modal
      closeModal.addEventListener("click", () => {
        patientDetailsModal.style.display = "none";
      });

      // Close modal when clicking outside
      patientDetailsModal.addEventListener("click", (e) => {
        if (e.target === patientDetailsModal) {
          patientDetailsModal.style.display = "none";
        }
      });

      // Search input event
      searchInput.addEventListener("input", (e) => {
        searchQuery = e.target.value;
        applyFiltersAndSearch();
      });

      // Filter buttons event
      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          // Update active state
          filterButtons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          // Apply filter
          currentFilter = button.dataset.filter;
          applyFiltersAndSearch();
        });
      });

      // Initial setup - Will be called after user authentication
    </script>
  </body>
</html>
